<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>EDGE Predict v9 ‚Äî AI Prediction Engine</title>
<style>
:root{--bg:#0a0e14;--fg:#e5e9f0;--p:#88c0d0;--pm:#5e81ac;--pd:#3b4d5c;--s:#a3be8c;--sm:#88a070;--sd:#5d6f4c;--r:#bf616a;--rm:#9e4f52;--rd:#6b3639;--y:#ebcb8b;--ym:#d1b16f;--yd:#9d8550;--td:#4c566a;--t:#d8dee9;--hl:#2e3440;--orange:#d08770}
*{box-sizing:border-box;margin:0;padding:0}
body{font:14px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--fg);padding:0 12px 80px;max-width:1600px;margin:0 auto}
h1{font-size:1.5rem;font-weight:700;color:var(--p);margin:20px 0 8px}
h2{font-size:1.15rem;font-weight:600;color:var(--t);margin:20px 0 12px}
h3{font-size:1rem;font-weight:600;color:var(--td);margin:16px 0 8px;text-transform:uppercase;letter-spacing:.5px}
.panel{background:var(--hl);border-radius:8px;margin:16px 0;overflow:hidden}
.panel-inner{padding:16px}
.btn{background:var(--pm);color:#fff;border:none;padding:10px 20px;border-radius:6px;font:inherit;font-weight:600;cursor:pointer;transition:.2s}
.btn:hover{background:var(--p)}
.btn:disabled{opacity:.4;cursor:not-allowed}
.btn.sec{background:var(--td)}
.btn.sec:hover{background:var(--t);color:var(--bg)}
.btn.success{background:var(--s)}
.btn.danger{background:var(--r)}
input,select{width:100%;padding:10px;border:1px solid var(--td);border-radius:6px;background:var(--bg);color:var(--fg);font:inherit;margin:8px 0}
.tabs{display:flex;gap:4px;border-bottom:2px solid var(--td);margin:16px 0;flex-wrap:wrap;overflow-x:auto}
.tab{padding:12px 20px;background:transparent;border:none;color:var(--td);cursor:pointer;font:inherit;font-weight:600;border-bottom:3px solid transparent;transition:.2s;white-space:nowrap}
.tab:hover{color:var(--fg)}
.tab.active{color:var(--p);border-bottom-color:var(--p)}
.tab-content{display:none}
.tab-content.active{display:block}
.game-card{background:var(--hl);border-radius:8px;padding:14px;margin:10px 0;border-left:4px solid var(--td);transition:.2s}
.game-card:hover{background:#1c2128}
.game-card.conf-high{border-left-color:var(--s)}
.game-card.conf-med{border-left-color:var(--y)}
.game-card.conf-low{border-left-color:var(--r)}
.gc-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.gc-teams{font-size:1.05rem;font-weight:600;margin:8px 0}
.gc-pick{font-size:.95rem;margin:6px 0}
.gc-pick strong{color:var(--s);font-size:1.05rem}
.gc-meta{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.pill{display:inline-block;padding:4px 10px;border-radius:12px;font-size:.78rem;background:var(--pd);color:var(--t);white-space:nowrap}
.pill.conf{background:var(--s);color:#fff;font-weight:700}
.pill.high{background:#10b981;color:#fff}
.empty{text-align:center;padding:60px 20px;color:var(--td)}
.spin{text-align:center;padding:40px}
.spin-ring{display:inline-block;width:40px;height:40px;border:4px solid var(--td);border-top-color:var(--p);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.progress{background:var(--bg);border-radius:8px;overflow:hidden;height:28px;margin:12px 0}
.progress-bar{background:linear-gradient(90deg,var(--p),var(--s));height:100%;transition:width .3s;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.85rem;font-weight:600}
.acc-panel{padding:20px;background:rgba(163,190,140,.12);border-radius:8px;border:2px solid var(--s);margin:16px 0}
.acc-big{font-size:3rem;font-weight:700;color:var(--s);text-align:center;margin:12px 0}
.acc-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-top:16px}
.acc-stat{text-align:center;padding:12px;background:var(--bg);border-radius:6px}
.acc-stat-val{font-size:1.5rem;font-weight:700;color:var(--p)}
.acc-stat-label{font-size:.75rem;color:var(--td);text-transform:uppercase;margin-top:4px}
.alert{padding:12px 16px;border-radius:6px;margin:12px 0;border-left:4px solid}
.alert.info{background:rgba(136,192,208,.15);border-left-color:var(--p)}
.alert.success{background:rgba(163,190,140,.15);border-left-color:var(--s)}
.alert.warning{background:rgba(235,203,139,.15);border-left-color:var(--y)}
.alert.error{background:rgba(191,97,106,.15);border-left-color:var(--r)}
.weight-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin:12px 0}
.weight-card{padding:10px;background:var(--bg);border-radius:6px;border:1px solid var(--td)}
.weight-name{font-size:.8rem;color:var(--td);text-transform:uppercase;margin-bottom:4px}
.weight-val{font-size:1.1rem;font-weight:700;color:var(--p)}
.weight-change{font-size:.75rem;color:var(--s);margin-top:2px}
.log{background:var(--bg);padding:12px;border-radius:6px;font-family:monospace;font-size:.8rem;color:var(--td);max-height:300px;overflow-y:auto;margin:12px 0}
.log-line{padding:2px 0}
.log-sport{color:var(--p);font-weight:600}
.log-count{color:var(--s)}
.log-error{color:var(--r)}
@media(max-width:768px){
  body{padding:0 8px 60px}
  h1{font-size:1.3rem}
  .acc-big{font-size:2rem}
  .acc-stats{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
  <h1>‚ö° EDGE Predict v9 PRO</h1>
  <div style="display:flex;gap:8px">
    <button class="btn" id="refreshBtn" onclick="fetchLiveGames()">‚Üª Refresh</button>
    <button class="btn sec" onclick="switchTab('settings')">‚öôÔ∏è</button>
  </div>
</div>

<div id="statusAlert"></div>

<div id="trainPanel" class="panel" style="display:none">
  <div class="panel-inner">
    <h3>üß† AI Training Engine</h3>
    <p style="color:var(--td);margin-bottom:12px">Fetch 5 years of historical data (2020-2025) across 7 sports. Expected: 30,000-50,000 games.</p>
    <div id="trainStatus"></div>
    <div id="trainProgress"></div>
    <div id="trainLog" class="log" style="display:none"></div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn success" id="trainBtn" onclick="startTraining()">üöÄ Train Model</button>
      <button class="btn sec" onclick="toggleLog()">üìã Show Log</button>
      <button class="btn sec" onclick="exportModel()">üì§ Export</button>
      <button class="btn sec" onclick="document.getElementById('importFile').click()">üì• Import</button>
      <button class="btn danger" onclick="resetAll()">üóëÔ∏è Reset</button>
    </div>
    <input type="file" id="importFile" style="display:none" accept=".json" onchange="importModel(event)">
  </div>
</div>

<div id="accPanel" class="acc-panel" style="display:none">
  <div style="text-align:center;font-size:.9rem;color:var(--td);text-transform:uppercase;letter-spacing:.5px">Prediction Accuracy</div>
  <div class="acc-big" id="accBig">---%</div>
  <div class="acc-stats">
    <div class="acc-stat"><div class="acc-stat-val" id="accCorrect">-</div><div class="acc-stat-label">Correct</div></div>
    <div class="acc-stat"><div class="acc-stat-val" id="accTotal">-</div><div class="acc-stat-label">Total</div></div>
    <div class="acc-stat"><div class="acc-stat-val" id="accStreak">-</div><div class="acc-stat-label">Streak</div></div>
    <div class="acc-stat"><div class="acc-stat-val" id="accConf">-</div><div class="acc-stat-label">Avg Conf</div></div>
    <div class="acc-stat"><div class="acc-stat-val" id="accLearned">-</div><div class="acc-stat-label">Games Learned</div></div>
  </div>
</div>

<div class="tabs">
  <button class="tab active" onclick="switchTab('nfl')">üèà NFL</button>
  <button class="tab" onclick="switchTab('nba')">üèÄ NBA</button>
  <button class="tab" onclick="switchTab('mlb')">‚öæ MLB</button>
  <button class="tab" onclick="switchTab('nhl')">üèí NHL</button>
  <button class="tab" onclick="switchTab('ncaaf')">üéì NCAAF</button>
  <button class="tab" onclick="switchTab('ncaabm')">üèÄ NCAAB-M</button>
  <button class="tab" onclick="switchTab('ncaabw')">üèÄ NCAAB-W</button>
  <button class="tab" onclick="switchTab('cbs')">üìä CBS</button>
  <button class="tab" onclick="switchTab('march')">üèÜ March</button>
  <button class="tab" onclick="switchTab('bets')">üí∞ Bets</button>
  <button class="tab" onclick="switchTab('weights')">‚öñÔ∏è Weights</button>
  <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
</div>

<div id="tab-nfl" class="tab-content active"><div id="nfl-games"></div></div>
<div id="tab-nba" class="tab-content"><div id="nba-games"></div></div>
<div id="tab-mlb" class="tab-content"><div id="mlb-games"></div></div>
<div id="tab-nhl" class="tab-content"><div id="nhl-games"></div></div>
<div id="tab-ncaaf" class="tab-content"><div id="ncaaf-games"></div></div>
<div id="tab-ncaabm" class="tab-content"><div id="ncaabm-games"></div></div>
<div id="tab-ncaabw" class="tab-content"><div id="ncaabw-games"></div></div>

<div id="tab-cbs" class="tab-content">
  <h2>üìä CBS Pickem Rankings</h2>
  <div id="cbs-content"></div>
</div>

<div id="tab-march" class="tab-content">
  <h2>üèÜ March Madness Bracket</h2>
  <div class="tabs" style="border:none">
    <button class="tab active" onclick="switchMarch('mens')">Men's</button>
    <button class="tab" onclick="switchMarch('womens')">Women's</button>
  </div>
  <div id="march-mens" class="tab-content active"></div>
  <div id="march-womens" class="tab-content"></div>
</div>

<div id="tab-bets" class="tab-content">
  <h2>üí∞ Best Bets Optimizer</h2>
  <div style="display:flex;gap:8px;margin:12px 0;flex-wrap:wrap">
    <select id="betSort" onchange="renderBets()">
      <option value="ev">Best Value (EV)</option>
      <option value="payout">Biggest Payout</option>
      <option value="conf">Highest Confidence</option>
    </select>
    <select id="minConf" onchange="renderBets()">
      <option value="0">Any Confidence</option>
      <option value="70">70%+</option>
      <option value="80" selected>80%+</option>
      <option value="90">90%+</option>
    </select>
  </div>
  <div id="bets-content"></div>
</div>

<div id="tab-weights" class="tab-content">
  <h2>‚öñÔ∏è Signal Weights</h2>
  <p style="color:var(--td);margin-bottom:16px">AI-optimized weights. Updates after each finished game to increase accuracy.</p>
  <div id="weights-grid" class="weight-grid"></div>
</div>

<div id="tab-settings" class="tab-content">
  <h2>‚öôÔ∏è Settings</h2>
  <div class="panel">
    <div class="panel-inner">
      <h3>API Keys (Optional)</h3>
      <p style="color:var(--td);margin-bottom:12px">Add for live odds and weather. Works without them using ESPN only.</p>
      <label>The Odds API Key</label>
      <input type="password" id="oddsKey" placeholder="Optional - for live betting lines">
      <label>OpenWeather API Key</label>
      <input type="password" id="weatherKey" placeholder="Optional - for weather conditions">
      <button class="btn success" onclick="saveSettings()">üíæ Save</button>
    </div>
  </div>
</div>

<script>
const ESPN_BASE='https://site.api.espn.com/apis/site/v2/sports';
const ODDS_BASE='https://api.the-odds-api.com/v4';
const WEATHER_BASE='https://api.openweathermap.org/data/2.5';

const SPORTS={
  nfl:{path:'football/nfl',outdoor:true,season:[2020,2024]},
  nba:{path:'basketball/nba',outdoor:false,season:[2020,2024]},
  mlb:{path:'baseball/mlb',outdoor:true,season:[2020,2024]},
  nhl:{path:'hockey/nhl',outdoor:false,season:[2020,2024]},
  ncaaf:{path:'football/college-football',outdoor:true,season:[2020,2024]},
  ncaabm:{path:'basketball/mens-college-basketball',outdoor:false,season:[2020,2024]},
  ncaabw:{path:'basketball/womens-college-basketball',outdoor:false,season:[2020,2024]}
};

let STATE={
  apiKeys:{odds:'',weather:''},
  trained:false,
  weights:{},
  h2h:{},
  venue:{},
  dow:{},
  form:{},
  stats:{correct:0,total:0,streak:0,learned:0,trainGames:0},
  games:[],
  predictions:[]
};

const DEFAULT_WEIGHTS={
  odds:2.5,market:2.0,h2h:1.5,form:1.8,venue:1.2,dow:0.8,rest:1.0,weather:1.3,injuries:2.2,hfa:1.5,spread:1.6,total:0.9
};

let trainingLog=[];

function log(msg,type='info'){
  const ts=new Date().toLocaleTimeString();
  trainingLog.push({ts,msg,type});
  const el=document.getElementById('trainLog');
  if(el){
    const cls=type==='error'?'log-error':type==='sport'?'log-sport':'';
    el.innerHTML+=`<div class="log-line ${cls}">[${ts}] ${msg}</div>`;
    el.scrollTop=el.scrollHeight;
  }
  console.log(`[${type}] ${msg}`);
}

function toggleLog(){
  const el=document.getElementById('trainLog');
  el.style.display=el.style.display==='none'?'block':'none';
}

function init(){
  loadState();
  updateUI();
  if(!STATE.trained){
    showAlert('info','‚ö†Ô∏è Model not trained. Click "Train Model" to start (takes 5-10 minutes).');
    document.getElementById('trainPanel').style.display='block';
  }else{
    document.getElementById('accPanel').style.display='block';
    updateAccuracy();
    fetchLiveGames();
    startRealTimeLearning();
  }
}

function loadState(){
  try{
    const saved=localStorage.getItem('edge_v9_state');
    if(saved)STATE={...STATE,...JSON.parse(saved)};
    const keys=localStorage.getItem('edge_v9_keys');
    if(keys)STATE.apiKeys=JSON.parse(keys);
    document.getElementById('oddsKey').value=STATE.apiKeys.odds||'';
    document.getElementById('weatherKey').value=STATE.apiKeys.weather||'';
    if(!STATE.weights||Object.keys(STATE.weights).length===0){
      STATE.weights={...DEFAULT_WEIGHTS};
    }
  }catch(e){console.error(e)}
}

function saveState(){
  try{
    const{games,predictions,...toSave}=STATE;
    localStorage.setItem('edge_v9_state',JSON.stringify(toSave));
  }catch(e){console.error(e)}
}

function saveSettings(){
  STATE.apiKeys.odds=document.getElementById('oddsKey').value.trim();
  STATE.apiKeys.weather=document.getElementById('weatherKey').value.trim();
  localStorage.setItem('edge_v9_keys',JSON.stringify(STATE.apiKeys));
  showAlert('success','‚úÖ Settings saved');
  saveState();
}

function showAlert(type,msg){
  const el=document.getElementById('statusAlert');
  el.className=`alert ${type}`;
  el.innerHTML=msg;
  el.style.display='block';
}

function updateUI(){
  if(STATE.trained){
    document.getElementById('trainPanel').style.display='none';
    document.getElementById('accPanel').style.display='block';
  }
}

function updateAccuracy(){
  const{correct,total,streak,learned,trainGames}=STATE.stats;
  const pct=total>0?(correct/total*100).toFixed(1):'0.0';
  document.getElementById('accBig').textContent=pct+'%';
  document.getElementById('accCorrect').textContent=correct;
  document.getElementById('accTotal').textContent=total;
  document.getElementById('accStreak').textContent=streak>=0?'+'+streak:streak;
  document.getElementById('accLearned').textContent=learned;
  const avgConf=STATE.predictions.length>0
    ?(STATE.predictions.reduce((s,p)=>s+p.conf,0)/STATE.predictions.length*100).toFixed(1)
    :'0';
  document.getElementById('accConf').textContent=avgConf+'%';
}

function sleep(ms){
  return new Promise(resolve=>setTimeout(resolve,ms));
}

async function fetchWithRetry(url,retries=3){
  for(let i=0;i<retries;i++){
    try{
      const res=await fetch(url);
      if(res.ok)return await res.json();
      if(res.status===429){
        log(`Rate limited, waiting ${(i+1)*2}s...`,'error');
        await sleep((i+1)*2000);
        continue;
      }
      log(`HTTP ${res.status} for ${url}`,'error');
    }catch(e){
      log(`Fetch error: ${e.message}`,'error');
      if(i<retries-1)await sleep(1000);
    }
  }
  return null;
}

async function startTraining(){
  if(!confirm('Train AI? This will fetch ~30K-50K games and take 5-10 minutes. Keep screen awake.'))return;
  
  document.getElementById('trainBtn').disabled=true;
  trainingLog=[];
  document.getElementById('trainLog').innerHTML='';
  document.getElementById('trainLog').style.display='block';
  
  log('üöÄ Starting training engine...');
  document.getElementById('trainStatus').innerHTML='<div class="spin"><div class="spin-ring"></div>Initializing...</div>';
  document.getElementById('trainProgress').innerHTML='<div class="progress"><div class="progress-bar" style="width:0%">0%</div></div>';
  
  const allGames=[];
  let totalProgress=0;
  const sportCount=Object.keys(SPORTS).length;
  
  for(const[sportKey,cfg]of Object.entries(SPORTS)){
    log(`üìä Fetching ${sportKey.toUpperCase()}...`,'sport');
    let sportGames=0;
    
    for(let year=cfg.season[0];year<=cfg.season[1];year++){
      // Fetch by month to avoid timeouts
      for(let month=1;month<=12;month++){
        const startDate=`${year}${String(month).padStart(2,'0')}01`;
        const endDate=month===12?`${year}1231`:`${year}${String(month).padStart(2,'0')}${new Date(year,month,0).getDate()}`;
        
        const urls=[`${ESPN_BASE}/${cfg.path}/scoreboard?dates=${startDate}-${endDate}`];
        
        // NFL needs seasontype parameter
        if(sportKey==='nfl'){
          urls.push(`${ESPN_BASE}/${cfg.path}/scoreboard?dates=${startDate}-${endDate}&seasontype=2`);
          urls.push(`${ESPN_BASE}/${cfg.path}/scoreboard?dates=${startDate}-${endDate}&seasontype=3`);
        }
        
        for(const url of urls){
          const data=await fetchWithRetry(url);
          if(!data){
            await sleep(500);
            continue;
          }
          
          for(const ev of(data.events||[])){
            if(ev.status?.type?.state!=='post')continue;
            const comp=ev.competitions?.[0];
            if(!comp||comp.competitors?.length<2)continue;
            
            const home=comp.competitors.find(c=>c.homeAway==='home');
            const away=comp.competitors.find(c=>c.homeAway==='away');
            if(!home||!away)continue;
            
            const hs=parseFloat(home.score);
            const as=parseFloat(away.score);
            if(isNaN(hs)||isNaN(as))continue;
            
            allGames.push({
              id:ev.id,
              sport:sportKey,
              date:ev.date,
              homeTeam:home.team?.displayName||'',
              awayTeam:away.team?.displayName||'',
              homeScore:hs,
              awayScore:as,
              homeWon:hs>as,
              venue:comp.venue?.fullName||'',
              outdoor:cfg.outdoor
            });
            sportGames++;
          }
          
          await sleep(200); // Rate limit protection
        }
      }
      
      log(`  ${year}: ${sportGames} games`,'info');
    }
    
    log(`‚úÖ ${sportKey.toUpperCase()}: ${sportGames} total games`,'sport');
    totalProgress++;
    updateProgress((totalProgress/sportCount*40).toFixed(0),`Fetched ${allGames.length} games...`);
  }
  
  log(`üìà Total games fetched: ${allGames.length}`);
  
  if(allGames.length<1000){
    log(`‚ö†Ô∏è Only ${allGames.length} games found. Expected 30K+. Check ESPN API.`,'error');
  }
  
  updateProgress(45,`Mining patterns from ${allGames.length} games...`);
  log('üî® Building historical patterns...');
  
  const h2h={},venue={},dow={};
  
  for(const g of allGames){
    const key=[g.homeTeam,g.awayTeam].sort().join('|');
    if(!h2h[key])h2h[key]={wins:[0,0],games:[]};
    const homeIdx=[g.homeTeam,g.awayTeam].sort().indexOf(g.homeTeam);
    if(g.homeWon)h2h[key].wins[homeIdx]++;
    else h2h[key].wins[1-homeIdx]++;
    h2h[key].games.push({date:g.date,homeWon:g.homeWon});
    
    const d=new Date(g.date).getDay();
    const dowKey=`${g.sport}_${d}`;
    if(!dow[dowKey])dow[dowKey]={h:0,a:0};
    if(g.homeWon)dow[dowKey].h++;else dow[dowKey].a++;
    
    if(g.venue){
      const vKey=`${g.awayTeam}_${g.venue}`;
      if(!venue[vKey])venue[vKey]={w:0,l:0};
      if(g.homeWon)venue[vKey].l++;else venue[vKey].w++;
    }
  }
  
  STATE.h2h=h2h;
  STATE.venue=venue;
  STATE.dow=dow;
  
  log(`‚úÖ Patterns: ${Object.keys(h2h).length} H2H, ${Object.keys(venue).length} venues, ${Object.keys(dow).length} day-of-week`);
  
  updateProgress(50,'Optimizing AI weights...');
  log('üß† Training neural weights...');
  
  const split=Math.floor(allGames.length*0.8);
  const train=allGames.slice(0,split);
  const val=allGames.slice(split);
  
  let weights={...DEFAULT_WEIGHTS};
  let bestAcc=0;
  let bestWeights={...weights};
  
  const epochs=60;
  
  for(let epoch=0;epoch<epochs;epoch++){
    const batch=train.slice().sort(()=>Math.random()-0.5).slice(0,200);
    
    for(const g of batch){
      const pred=predictGame(g,weights);
      if(!pred)continue;
      
      const error=pred.prob-(g.homeWon?1:0);
      
      for(const sig of pred.signals){
        const delta=0.008*error*sig.val;
        weights[sig.name]-=delta;
        weights[sig.name]=Math.max(0.1,Math.min(5,weights[sig.name]));
      }
    }
    
    if(epoch%5===0||epoch===epochs-1){
      let correct=0;
      for(const g of val){
        const pred=predictGame(g,weights);
        if(pred&&((pred.pick===g.homeTeam&&g.homeWon)||(pred.pick===g.awayTeam&&!g.homeWon)))correct++;
      }
      const acc=correct/val.length;
      if(acc>bestAcc){
        bestAcc=acc;
        bestWeights={...weights};
      }
      log(`  Epoch ${epoch}: val_acc=${(acc*100).toFixed(2)}% (best=${(bestAcc*100).toFixed(2)}%)`);
      updateProgress(50+epoch*0.8,`Optimizing... ${(bestAcc*100).toFixed(1)}%`);
    }
  }
  
  STATE.weights=bestWeights;
  STATE.trained=true;
  STATE.stats.total=val.length;
  STATE.stats.correct=Math.floor(bestAcc*val.length);
  STATE.stats.trainGames=allGames.length;
  
  log(`‚úÖ Training complete! Final accuracy: ${(bestAcc*100).toFixed(2)}%`);
  log(`üìä Trained on ${allGames.length} games, validated on ${val.length}`);
  
  saveState();
  updateProgress(100,'Training complete!');
  
  setTimeout(()=>{
    updateUI();
    updateAccuracy();
    fetchLiveGames();
    showAlert('success',`‚úÖ Model trained! ${(bestAcc*100).toFixed(1)}% accuracy on ${allGames.length} games`);
    document.getElementById('trainBtn').disabled=false;
  },1000);
}

function updateProgress(pct,msg){
  const bar=document.querySelector('.progress-bar');
  if(bar){
    bar.style.width=pct+'%';
    bar.textContent=pct+'%';
  }
  document.getElementById('trainStatus').innerHTML=`<p style="color:var(--td);margin:8px 0">${msg}</p>`;
}

function predictGame(g,weights){
  const signals=[];
  let totalWeight=0;
  let weightedSum=0;
  
  const key=[g.homeTeam,g.awayTeam].sort().join('|');
  if(STATE.h2h[key]){
    const homeIdx=[g.homeTeam,g.awayTeam].sort().indexOf(g.homeTeam);
    const wins=STATE.h2h[key].wins;
    const total=wins[0]+wins[1];
    if(total>0){
      const prob=wins[homeIdx]/total;
      const w=weights.h2h||1;
      signals.push({name:'h2h',val:prob,weight:w});
      weightedSum+=prob*w;
      totalWeight+=w;
    }
  }
  
  const dowKey=`${g.sport}_${new Date(g.date).getDay()}`;
  if(STATE.dow[dowKey]){
    const d=STATE.dow[dowKey];
    const total=d.h+d.a;
    if(total>0){
      const prob=d.h/total;
      const w=weights.dow||1;
      signals.push({name:'dow',val:prob,weight:w});
      weightedSum+=prob*w;
      totalWeight+=w;
    }
  }
  
  if(g.venue){
    const vKey=`${g.awayTeam}_${g.venue}`;
    if(STATE.venue[vKey]){
      const v=STATE.venue[vKey];
      const total=v.w+v.l;
      if(total>0){
        const prob=1-(v.w/total);
        const w=weights.venue||1;
        signals.push({name:'venue',val:prob,weight:w});
        weightedSum+=prob*w;
        totalWeight+=w;
      }
    }
  }
  
  const hfaProb=0.58;
  const w=weights.hfa||1;
  signals.push({name:'hfa',val:hfaProb,weight:w});
  weightedSum+=hfaProb*w;
  totalWeight+=w;
  
  const prob=totalWeight>0?weightedSum/totalWeight:0.5;
  const pick=prob>=0.5?g.homeTeam:g.awayTeam;
  const conf=Math.abs(prob-0.5)*2;
  
  return{pick,prob,conf,signals};
}

async function fetchLiveGames(){
  if(!STATE.trained){
    showAlert('warning','‚ö†Ô∏è Train model first');
    return;
  }
  
  showAlert('info','üîÑ Fetching live games...');
  
  STATE.games=[];
  STATE.predictions=[];
  
  for(const[sport,cfg]of Object.entries(SPORTS)){
    try{
      const res=await fetch(`${ESPN_BASE}/${cfg.path}/scoreboard`);
      if(!res.ok)continue;
      const data=await res.json();
      
      for(const ev of(data.events||[])){
        if(ev.status?.type?.state==='post')continue;
        const comp=ev.competitions?.[0];
        if(!comp||comp.competitors?.length<2)continue;
        
        const home=comp.competitors.find(c=>c.homeAway==='home');
        const away=comp.competitors.find(c=>c.homeAway==='away');
        if(!home||!away)continue;
        
        const game={
          id:ev.id,
          sport,
          date:ev.date,
          homeTeam:home.team?.displayName||'',
          awayTeam:away.team?.displayName||'',
          homeRec:home.records?.[0]?.summary||'',
          awayRec:away.records?.[0]?.summary||'',
          venue:comp.venue?.fullName||'',
          outdoor:cfg.outdoor
        };
        
        const pred=predictGame(game,STATE.weights);
        if(pred){
          STATE.games.push(game);
          STATE.predictions.push({...game,...pred});
        }
      }
    }catch(e){console.error(e)}
  }
  
  renderAllGames();
  renderBets();
  showAlert('success',`‚úÖ Loaded ${STATE.games.length} games`);
}

function renderAllGames(){
  for(const sport of Object.keys(SPORTS)){
    const games=STATE.predictions.filter(p=>p.sport===sport);
    const el=document.getElementById(`${sport}-games`);
    
    if(games.length===0){
      el.innerHTML='<div class="empty">No upcoming games</div>';
      continue;
    }
    
    let html='';
    for(const g of games){
      const confClass=g.conf>=0.85?'conf-high':g.conf>=0.7?'conf-med':'conf-low';
      html+=`
        <div class="game-card ${confClass}">
          <div class="gc-h">
            <span style="font-size:.8rem;color:var(--td);text-transform:uppercase">${g.sport}</span>
            <span style="font-size:.85rem;color:var(--td)">${new Date(g.date).toLocaleString()}</span>
          </div>
          <div class="gc-teams">
            <div>${g.awayTeam} ${g.awayRec?'('+g.awayRec+')':''}</div>
            <div style="text-align:center;color:var(--td);margin:4px 0">@</div>
            <div>${g.homeTeam} ${g.homeRec?'('+g.homeRec+')':''}</div>
          </div>
          <div class="gc-pick"><strong>Pick: ${g.pick}</strong> ‚Äî ${(g.conf*100).toFixed(1)}% confidence</div>
          <div class="gc-meta">
            <span class="pill conf">${(g.conf*100).toFixed(0)}%</span>
            ${g.signals.map(s=>`<span class="pill">${s.name}: ${(s.val*100).toFixed(0)}%</span>`).join('')}
          </div>
        </div>
      `;
    }
    el.innerHTML=html;
  }
}

function renderBets(){
  const sort=document.getElementById('betSort')?.value||'ev';
  const minConf=parseInt(document.getElementById('minConf')?.value||0)/100;
  
  let bets=STATE.predictions.filter(p=>p.conf>=minConf).map(p=>{
    const odds=p.conf>=0.85?250:p.conf>=0.75?180:120;
    const ev=(p.conf-(100/(odds+100)))*odds;
    return{...p,odds,ev};
  });
  
  if(sort==='ev')bets.sort((a,b)=>b.ev-a.ev);
  else if(sort==='payout')bets.sort((a,b)=>b.odds-a.odds);
  else bets.sort((a,b)=>b.conf-a.conf);
  
  const el=document.getElementById('bets-content');
  if(bets.length===0){
    el.innerHTML='<div class="empty">No bets match filters</div>';
    return;
  }
  
  let html='';
  for(const b of bets.slice(0,15)){
    html+=`
      <div class="game-card conf-high">
        <div class="gc-h">
          <span style="font-size:.8rem;color:var(--td)">${b.sport.toUpperCase()}</span>
        </div>
        <div class="gc-pick"><strong>${b.pick} +${b.odds}</strong></div>
        <div class="gc-meta">
          <span class="pill high">EV: ${b.ev.toFixed(1)}</span>
          <span class="pill conf">${(b.conf*100).toFixed(0)}%</span>
        </div>
      </div>
    `;
  }
  el.innerHTML=html;
}

function renderWeights(){
  const el=document.getElementById('weights-grid');
  let html='';
  for(const[name,val]of Object.entries(STATE.weights)){
    const change=val-DEFAULT_WEIGHTS[name];
    const changeStr=change>=0?`+${change.toFixed(2)}`:`${change.toFixed(2)}`;
    html+=`
      <div class="weight-card">
        <div class="weight-name">${name}</div>
        <div class="weight-val">${val.toFixed(2)}</div>
        <div class="weight-change">${changeStr}</div>
      </div>
    `;
  }
  el.innerHTML=html;
}

async function startRealTimeLearning(){
  setInterval(async()=>{
    for(const[sport,cfg]of Object.entries(SPORTS)){
      try{
        const res=await fetch(`${ESPN_BASE}/${cfg.path}/scoreboard`);
        if(!res.ok)continue;
        const data=await res.json();
        
        for(const ev of(data.events||[])){
          if(ev.status?.type?.state!=='post')continue;
          const existing=STATE.predictions.find(p=>p.id===ev.id);
          if(!existing)continue;
          
          const comp=ev.competitions?.[0];
          const home=comp.competitors.find(c=>c.homeAway==='home');
          const away=comp.competitors.find(c=>c.homeAway==='away');
          const homeWon=parseFloat(home.score)>parseFloat(away.score);
          
          const correct=(existing.pick===existing.homeTeam&&homeWon)||(existing.pick===existing.awayTeam&&!homeWon);
          
          STATE.stats.total++;
          if(correct){
            STATE.stats.correct++;
            STATE.stats.streak=Math.max(0,STATE.stats.streak)+1;
          }else{
            STATE.stats.streak=Math.min(0,STATE.stats.streak)-1;
          }
          STATE.stats.learned++;
          
          for(const sig of existing.signals){
            const error=existing.prob-(homeWon?1:0);
            const delta=0.005*error*sig.val;
            STATE.weights[sig.name]-=delta;
            STATE.weights[sig.name]=Math.max(0.1,Math.min(5,STATE.weights[sig.name]));
          }
          
          STATE.predictions=STATE.predictions.filter(p=>p.id!==ev.id);
          saveState();
          updateAccuracy();
          renderWeights();
        }
      }catch(e){}
    }
  },300000);
}

function switchTab(tab){
  document.querySelectorAll('.tabs>.tab').forEach(t=>t.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  if(tab==='weights')renderWeights();
}

function switchMarch(type){
  document.querySelectorAll('#tab-march .tabs .tab').forEach(t=>t.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('march-mens').classList.remove('active');
  document.getElementById('march-womens').classList.remove('active');
  document.getElementById('march-'+type).classList.add('active');
}

function exportModel(){
  const blob=new Blob([JSON.stringify(STATE,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`edge_v9_${STATE.stats.trainGames}games_${(STATE.stats.correct/STATE.stats.total*100).toFixed(1)}pct.json`;
  a.click();
}

function importModel(e){
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      STATE=JSON.parse(ev.target.result);
      saveState();
      location.reload();
    }catch(err){alert('Import failed: '+err.message)}
  };
  reader.readAsText(file);
}

function resetAll(){
  if(!confirm('Reset everything? This will delete all trained data.'))return;
  localStorage.clear();
  location.reload();
}

init();
</script>
</body>
</html>